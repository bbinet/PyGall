<%!
    import os
%>
<%
    dirs = {}
    rows = []
    id = 0
    for path in c.tree:
        id += 1
        row = {}
        row['id'] = id
        row['path'] = path
        row['class'] = "file"
        if path.endswith(os.sep):
            path = path[:-1]
            dirs[path] = id
            row['class'] = "folder"
        parent = os.path.dirname(path)
        row['parent'] = dirs[parent] if dirs.has_key(parent) else None
        rows.append(row)
%>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Import de photos</title>
    <link href="${url('/lib/treeTable/css/jquery.treeTable.css')}" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="${url('/css/style.css')}">
    <script src="${url('/js/jquery.min.js')}" type="text/javascript"></script>
    <script src="${url('/lib/treeTable/js/jquery.treeTable.min.js')}" type="text/javascript"></script>
    <script type="text/javascript">
    $(document).ready(function() {
        $("table#photos-tree").treeTable({
            initialState: "expanded"
        });

        // make visible that a row is clicked
        $("table#photos-tree tbody tr").mousedown(function() {
            $("tr.selected").removeClass("selected"); // Deselect currently selected rows
            $(this).addClass("selected");
        });

        // make sure row is selected when span is clicked
        $("table#photos-tree tbody tr span").mousedown(function() {
            $($(this).parents("tr")[0]).trigger("mousedown");
        });

        $("table#photos-tree tfoot input").click(function() {
            $('#flash').text(''); // reinit flash message
            var action = this.name;
            $('table#photos-tree tbody tr input[name="'+this.name+'"]:checked')
            .each(function() {
                // do not send request for directories
                if ($(this).parents("tr").find("td span").attr('class') == 'file') {
                    var path = $(this).parents("tr").find("td span").text();
                    switch (action) {
                    case "import":
                        $.post(
                            "${url('photos')}",
                            { path: path },
                            function(response){
                                if (response.status == true) {
                                    $('table#photos-tree tbody tr td span.file').filter(
                                        function(){
                                            return $(this).text()==path;
                                        }
                                    ).parents("tr").remove();
                                }
                                else {
                                    var current_flash = $('#flash').html();
                                    if (current_flash) {
                                        current_flash += "<br />";
                                        }
                                    $('#flash').html(current_flash + response.msg);
                                }
                            },
                            "json"
                        );
                        break;
                    case "delete":
                        $.post(
                            "${url(controller='import', action='delete')}",
                            { path: path },
                            function(response){
                                if (response.status == true) {
                                    $('table#photos-tree tbody tr td span.file').filter(
                                        function(){
                                            return $(this).text()==path;
                                        }
                                    ).parents("tr").remove();
                                }
                            },
                            "json"
                        );
                        break;
                    }
                }
            });
        });

        // checking nodes will check corresponding leafs
        $.each(${dirs.values()}, function(index, value) {
            $('#node-'+value+' input[type="checkbox"]').change(function() {
                $('.child-of-node-'+value+' input[name="'+this.name+'"]')
                .attr('checked', $(this).is(':checked'))
                .trigger('change');
            });
        });
    });
    </script>
</head>
<body>
    <div id="flash"></div>
    <h3>Importer les photos dans la gallerie PyGall</h1>
    <a href="${url(controller='import', action='new')}">Upload</a> |
    <a href="${url(controller='photos', action='galleria')}">Galleria</a>
    <table id="photos-tree">
        <thead>
            <tr>
                <th>Titre</th>
                <th>Importer</th>
                <th>Supprimer</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <td></td>
                <td><input type="button" name="import" value="Importer"></td>
                <td><input type="button" name="delete" value="Supprimer"></td>
            </tr>
        </tfoot>
        <tbody>
        % for row in rows:
            % if row['parent'] is None:
            <tr id="node-${row['id']}">
            % else:
            <tr id="node-${row['id']}" class="child-of-node-${row['parent']}">
            % endif
                <td><span class="${row['class']}">${row['path']}</span></td>
                <td><input type="checkbox" name="import" value="${row['id']}"></td>
                <td><input type="checkbox" name="delete" value="${row['id']}"></td>
            </tr>
        % endfor
        </tbody>
    </table>
</body>
</html>
